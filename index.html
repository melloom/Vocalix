<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    <!-- Critical CSS fallback for mobile white screen fix -->
    <style>
      html, body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        width: 100%;
        background-color: #f9f7f3;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      }
      #root {
        min-height: 100vh;
        width: 100%;
        background-color: #f9f7f3;
      }
    </style>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <title>Echo Garden</title>
    <meta
      name="description"
      content="Echo Garden helps you capture and share meaningful voice notes."
    />
    <meta name="author" content="Echo Garden" />

    <meta property="og:title" content="Echo Garden" />
    <meta
      property="og:description"
      content="Echo Garden helps you capture and share meaningful voice notes."
    />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="/placeholder.svg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content="/placeholder.svg" />
  </head>

  <body>
    <div id="root">
      <!-- Loading fallback for mobile - shows immediately while JS loads -->
      <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background-color: #f9f7f3; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;">
        <div style="text-align: center; padding: 20px;">
          <div style="width: 40px; height: 40px; border: 4px solid #e0e0e0; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
          <p style="color: #666; font-size: 16px;">Loading Echo Garden...</p>
        </div>
      </div>
      <style>
        @keyframes spin {
          to { transform: rotate(360deg); }
        }
      </style>
    </div>
    <script>
      // Enhanced script loader with error detection for mobile
      (function() {
        const script = document.createElement('script');
        script.type = 'module';
        script.src = '/src/main.tsx';
        script.crossOrigin = 'anonymous';
        
        let loadTimeout;
        let hasLoaded = false;
        
        script.onload = function() {
          hasLoaded = true;
          if (loadTimeout) clearTimeout(loadTimeout);
          window.__APP_SCRIPT_LOADED__ = true;
          console.log('[HTML] Main script loaded successfully');
        };
        
        script.onerror = function(e) {
          console.error('[HTML] Script failed to load:', {
            src: script.src,
            error: e,
            readyState: script.readyState
          });
          
          var root = document.getElementById('root');
          if (root) {
            root.innerHTML = '<div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; background-color: #f9f7f3; font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;"><div style="max-width: 500px; text-align: center;"><h1 style="font-size: 24px; margin-bottom: 16px; color: #333;">Script Failed to Load</h1><p style="color: #666; margin-bottom: 12px;">The main application script could not be loaded.</p><p style="color: #999; font-size: 12px; margin-bottom: 24px;">File: /src/main.tsx</p><div style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center;"><button onclick="window.location.reload()" style="padding: 12px 24px; background-color: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">Refresh Page</button><button onclick="if(confirm(\'Reset all caches?\')){window.__resetAppCache(true);}" style="padding: 12px 24px; background-color: transparent; color: #667eea; border: 1px solid #667eea; border-radius: 8px; font-size: 16px; cursor: pointer;">Reset Cache</button></div></div></div>';
          }
        };
        
        // Timeout after 10 seconds
        loadTimeout = setTimeout(function() {
          if (!hasLoaded) {
            console.error('[HTML] Script load timeout after 10 seconds');
            script.onerror(new Error('Load timeout'));
          }
        }, 10000);
        
        // Try to load the script
        document.head.appendChild(script);
      })();
    </script>
    <script>
      // Mobile Debug Panel - Shows logs on screen for iPhone debugging
      (function() {
        let logContainer = null;
        let logs = [];
        const maxLogs = 50;
        
        function createDebugPanel() {
          if (logContainer) return;
          
          logContainer = document.createElement('div');
          logContainer.id = 'mobile-debug-panel';
          logContainer.style.cssText = 'position: fixed; bottom: 10px; right: 10px; width: 90%; max-width: 400px; max-height: 300px; background: rgba(0,0,0,0.9); color: #0f0; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 11px; z-index: 99999; overflow-y: auto; display: none; border: 2px solid #0f0;';
          
          const toggleBtn = document.createElement('button');
          toggleBtn.textContent = 'ðŸ“± Debug';
          toggleBtn.style.cssText = 'position: fixed; bottom: 10px; right: 10px; padding: 8px 12px; background: #667eea; color: white; border: none; border-radius: 20px; font-size: 12px; z-index: 99998; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3);';
          toggleBtn.onclick = function() {
            logContainer.style.display = logContainer.style.display === 'none' ? 'block' : 'none';
          };
          
          const clearBtn = document.createElement('button');
          clearBtn.textContent = 'Clear';
          clearBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; padding: 4px 8px; background: #f00; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer;';
          clearBtn.onclick = function() {
            logs = [];
            updateLogDisplay();
          };
          logContainer.appendChild(clearBtn);
          
          document.body.appendChild(logContainer);
          document.body.appendChild(toggleBtn);
        }
        
        function addLog(level, message, data) {
          if (!logContainer) createDebugPanel();
          
          const timestamp = new Date().toLocaleTimeString();
          const logEntry = {
            time: timestamp,
            level: level,
            message: message,
            data: data
          };
          
          logs.push(logEntry);
          if (logs.length > maxLogs) logs.shift();
          
          updateLogDisplay();
        }
        
        function updateLogDisplay() {
          if (!logContainer) return;
          
          const colors = {
            log: '#0f0',
            warn: '#ff0',
            error: '#f00',
            info: '#0ff'
          };
          
          logContainer.innerHTML = '<button onclick="this.parentElement.style.display=\'none\'" style="position: absolute; top: 5px; right: 5px; padding: 4px 8px; background: #f00; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer;">Clear</button><div style="margin-top: 25px;">' +
            logs.map(log => {
              const color = colors[log.level] || '#fff';
              const dataStr = log.data ? ' ' + JSON.stringify(log.data).substring(0, 100) : '';
              return `<div style="color: ${color}; margin-bottom: 4px; word-break: break-word;"><span style="opacity: 0.7;">[${log.time}]</span> <strong>[${log.level.toUpperCase()}]</strong> ${log.message}${dataStr}</div>`;
            }).join('') +
            '</div>';
        }
        
        // Override console methods
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        const originalInfo = console.info;
        
        console.log = function(...args) {
          originalLog.apply(console, args);
          addLog('log', args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '));
        };
        
        console.warn = function(...args) {
          originalWarn.apply(console, args);
          addLog('warn', args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '));
        };
        
        console.error = function(...args) {
          originalError.apply(console, args);
          addLog('error', args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '));
        };
        
        console.info = function(...args) {
          originalInfo.apply(console, args);
          addLog('info', args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '));
        };
        
        // Show panel automatically if there are errors
        setTimeout(function() {
          if (logs.some(l => l.level === 'error')) {
            if (logContainer) logContainer.style.display = 'block';
          }
        }, 3000);
      })();
      
      // Track if script loaded
      window.__APP_SCRIPT_LOADED__ = false;
      window.__RESET_ATTEMPTED__ = false;
      window.__RESET_IN_PROGRESS__ = false;
      
      async function resetAppCacheAndReload(forceReload = true) {
        if (window.__RESET_IN_PROGRESS__) return;
        window.__RESET_IN_PROGRESS__ = true;
        
        try {
          if ("serviceWorker" in navigator) {
            const registrations = await navigator.serviceWorker.getRegistrations();
            await Promise.all(registrations.map((reg) => reg.unregister()));
          }
          
          if (window.caches && typeof window.caches.keys === "function") {
            const cacheNames = await window.caches.keys();
            await Promise.all(cacheNames.map((cacheName) => window.caches.delete(cacheName)));
          }
        } catch (resetError) {
          console.error("[HTML] Failed to reset caches:", resetError);
        } finally {
          if (forceReload) {
            setTimeout(() => window.location.reload(), 100);
          } else {
            window.__RESET_IN_PROGRESS__ = false;
          }
        }
      }
      
      window.__resetAppCache = resetAppCacheAndReload;
      
      // Fallback error handler if main script fails to load (mobile browsers)
      window.addEventListener('error', function(e) {
        console.error('[HTML] Global error caught:', {
          message: e.message,
          filename: e.filename,
          lineno: e.lineno,
          colno: e.colno,
          error: e.error,
          isTrusted: e.isTrusted,
          type: e.type,
          target: e.target
        });
        
        // Check for React loading errors specifically
        const isReactError = e.message && (
          e.message.includes('createContext') ||
          e.message.includes('undefined is not an object') ||
          e.message.includes('React') ||
          e.filename?.includes('react')
        );
        
        // Check if it's a script loading error (network failure, 404, etc.)
        const isScriptError = e.target && (
          e.target.tagName === 'SCRIPT' ||
          e.target.tagName === 'LINK' ||
          e.filename?.includes('main.tsx') ||
          e.filename?.includes('.js') ||
          e.filename?.includes('.tsx') ||
          e.filename?.includes('.mjs') ||
          e.message?.includes('Failed to fetch') ||
          e.message?.includes('NetworkError') ||
          e.message?.includes('Load failed')
        );
        
        if (isScriptError || isReactError) {
          console.error('[HTML] Script loading error detected:', {
            filename: e.filename || (e.target ? e.target.src || e.target.href : 'unknown'),
            message: e.message,
            error: e.error
          });
          
          var root = document.getElementById('root');
          if (root && (!window.__APP_SCRIPT_LOADED__ || isReactError || isScriptError)) {
            // Try auto-reset once
            if (!window.__RESET_ATTEMPTED__ && (navigator.serviceWorker || window.caches)) {
              window.__RESET_ATTEMPTED__ = true;
              console.log('[HTML] Attempting automatic cache reset...');
              resetAppCacheAndReload(true);
              return;
            }
            
            // Build detailed error message
            var errorDetails = '';
            if (e.filename) errorDetails += '<br><small style="color: #999;">File: ' + e.filename + '</small>';
            if (e.message) errorDetails += '<br><small style="color: #999;">Error: ' + e.message + '</small>';
            if (e.target && e.target.src) errorDetails += '<br><small style="color: #999;">URL: ' + e.target.src + '</small>';
            
            var errorMsg = isReactError 
              ? 'React failed to load. This can happen on mobile browsers with cached files.'
              : 'Script failed to load. This might be a network issue or cached file problem.';
            
            root.innerHTML = '<div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; background-color: #f9f7f3; font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;"><div style="max-width: 500px; text-align: center;"><h1 style="font-size: 24px; margin-bottom: 16px; color: #333;">' + (isReactError ? 'React Loading Error' : 'Script Loading Error') + '</h1><p style="color: #666; margin-bottom: 12px;">' + errorMsg + '</p>' + errorDetails + '<div style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top: 24px;"><button onclick="window.location.reload()" style="padding: 12px 24px; background-color: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">Refresh Page</button><button onclick="if(confirm(\'Completely reset cached files?\')){window.__resetAppCache(true);}" style="padding: 12px 24px; background-color: transparent; color: #667eea; border: 1px solid #667eea; border-radius: 8px; font-size: 16px; cursor: pointer;">Reset App Cache</button><button onclick="if(confirm(\'Clear local/session storage?\')){localStorage.clear();sessionStorage.clear();window.location.reload();}" style="padding: 12px 24px; background-color: transparent; color: #667eea; border: 1px solid #667eea; border-radius: 8px; font-size: 16px; cursor: pointer;">Clear Storage</button></div></div></div>';
          }
        }
      }, true);
      
      // Track unhandled promise rejections
      window.addEventListener('unhandledrejection', function(e) {
        console.error('[HTML] Unhandled promise rejection:', e.reason);
      });
      
      // Timeout fallback - if app doesn't load within 15 seconds, show error
      setTimeout(function() {
        var root = document.getElementById('root');
        // Check if still showing loading screen OR if root is empty (app didn't render)
        var stillLoading = root && (
          (root.children.length === 1 && root.querySelector('div[style*="Loading Echo Garden"]')) ||
          (root.children.length === 0 && root.innerHTML.includes('Loading Echo Garden'))
        );
        if (stillLoading) {
          console.error('[App] Timeout: App did not load within 15 seconds');
          root.innerHTML = '<div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; background-color: #f9f7f3; font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;"><div style="max-width: 400px; text-align: center;"><h1 style="font-size: 24px; margin-bottom: 16px; color: #333;">Loading Taking Too Long</h1><p style="color: #666; margin-bottom: 24px;">The app is taking longer than expected to load. This might be due to a slow connection or a JavaScript error. Please check the browser console and try refreshing.</p><button onclick="window.location.reload()" style="padding: 12px 24px; background-color: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-right: 8px;">Refresh Page</button><button onclick="if(navigator.onLine){window.location.reload()}else{alert(\'You appear to be offline. Please check your internet connection.\')}" style="padding: 12px 24px; background-color: transparent; color: #667eea; border: 1px solid #667eea; border-radius: 8px; font-size: 16px; cursor: pointer;">Check Connection</button></div></div>';
        }
      }, 15000);
    </script>
  </body>
</html>
